// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String      @id @default(cuid())
  email         String      @unique
  name          String?
  portfolios    Portfolio[]  // Relation to Portfolio
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  alerts        PriceAlert[]
  notifications Notification[]
}

model Portfolio {
  id          String     @id @default(cuid())
  name        String
  userId      String     // Add this field
  user        User       @relation(fields: [userId], references: [id])  // Add this relation
  cashBalance Float      @default(10000.00)
  positions   Position[]
  transactions Transaction[]
  values      PortfolioValue[]
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
}


model Position {
  id          String   @id @default(cuid())
  portfolioId String
  portfolio   Portfolio @relation(fields: [portfolioId], references: [id])
  symbol      String
  quantity    Float
  avgPrice    Float
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([portfolioId, symbol])
}

model Transaction {
  id          String   @id @default(cuid())
  portfolioId String
  portfolio   Portfolio @relation(fields: [portfolioId], references: [id])
  symbol      String
  type        String   // 'BUY' or 'SELL'
  quantity    Float
  price       Float
  amount      Float
  createdAt   DateTime @default(now())
}

model PortfolioValue {
  id          String   @id @default(cuid())
  name        String 
  portfolioId String
  portfolio   Portfolio @relation(fields: [portfolioId], references: [id])
  value       Float
  date        DateTime @default(now())
}

// Add to prisma/schema.prisma

model PriceAlert {
  id            String              @id @default(cuid())
  userId        String
  user          User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  symbol        String              // e.g., "BTCUSDT"
  assetName     String              // e.g., "Bitcoin"
  
  // Alert conditions
  alertType     AlertType           // PRICE_ABOVE, PRICE_BELOW, PERCENT_CHANGE, VOLUME_SPIKE
  targetPrice   Float?              // For price-based alerts
  percentChange Float?              // For % change alerts
  
  // Notification preferences
  notifications      Notification[]
  deliveryMethods    AlertDeliveryMethod[]
  
  // Status
  isActive      Boolean     @default(true)
  lastTriggered DateTime?   
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  // Unique constraint per user per symbol per alert type
  @@unique([userId, symbol, alertType, targetPrice])
}

model AlertDeliveryMethod {
  id      String  @id @default(cuid())
  alertId String
  alert   PriceAlert @relation(fields: [alertId], references: [id], onDelete: Cascade)
  method  DeliveryMethod
  enabled Boolean @default(true)
  
  @@unique([alertId, method])
}

model Notification {
  id            String      @id @default(cuid())
  userId        String
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  alertId       String
  alert         PriceAlert  @relation(fields: [alertId], references: [id], onDelete: Cascade)
  
  message       String
  read          Boolean     @default(false)
  deliveryMethod DeliveryMethod
  deliveredAt   DateTime?
  
  createdAt     DateTime    @default(now())
}

enum AlertType {
  PRICE_ABOVE
  PRICE_BELOW
  PERCENT_CHANGE
  VOLUME_SPIKE
}

enum DeliveryMethod {
  IN_APP
  EMAIL
  PUSH
}